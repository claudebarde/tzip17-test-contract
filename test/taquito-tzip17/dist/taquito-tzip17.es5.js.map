{"version":3,"file":"taquito-tzip17.es5.js","sources":["../src/taquito-tzip17.ts"],"sourcesContent":["import { Context, ContractAbstraction, ContractMethod, ContractProvider, Wallet } from \"@taquito/taquito\";\nimport { buf2hex } from \"@taquito/utils\";\nimport { blake2b } from \"blakejs\";\nimport { MichelsonData, packDataBytes } from \"@taquito/michel-codec\";\n\nconst sigParamData = (chainId: string, contractAddress: string, counter: string, methodHash: string): MichelsonData => {\n  return {\n    prim: \"Pair\",\n    args: [\n      {\n        prim: \"Pair\",\n        args: [\n          {\n            string: chainId\n          },\n          {\n            string: contractAddress\n          }\n        ]\n      },\n      {\n        prim: \"Pair\",\n        args: [\n          {\n            int: counter\n          },\n          {\n            bytes: methodHash\n          }\n        ]\n      }\n    ]\n  }\n};\n\nconst sigParamType: any = {\n  prim: \"pair\",\n  args: [\n    {\n      prim: \"pair\",\n      args: [\n        {\n          prim: \"chain_id\"\n        },\n        { prim: \"address\" }\n      ]\n    },\n    {\n      prim: \"pair\",\n      args: [{ prim: \"nat\" }, { prim: \"bytes\" }]\n    }\n  ]\n};\n\nclass ContractMethodTzip17<T extends ContractProvider | Wallet> {\n\n  constructor(\n    private context: Context,\n    private contractAbs: ContractAbstraction<T>,\n    private method: (...args: any[]) => ContractMethod<T>,\n    private parameterType: object,\n    private args: any[]\n  ) { }\n  async createPermit() {\n    const methodHash = await this.prepareMethodHash();\n    const packedData = await this.packData(methodHash);\n    const signature = await this.context.signer.sign(packedData.bytes);\n    const publicKey = await this.context.signer.publicKey();\n    return { publicKey, signature: signature.sig, methodHash }\n\n  }\n  private createTransferParam() {\n    return this.method(...this.args).toTransferParams().parameter?.value;\n  }\n\n  private async packTransfeerParam() {\n    const rawPacked = await this.context.packer.packData({\n      data: this.createTransferParam()!,\n      type: this.parameterType\n    });\n    return rawPacked.packed;\n  }\n\n  private async prepareMethodHash() {\n    const packedParam = await this.packTransfeerParam();\n    return buf2hex(Buffer.from(blake2b(packedParam)));\n  }\n\n  private async packData(methodHash: string) {\n    const chainId = await this.context.rpc.getChainId();\n    const contractStorage: any = await this.contractAbs.storage();\n    const counter = contractStorage.counter;\n    return packDataBytes(sigParamData(chainId, this.contractAbs.address, counter, methodHash), sigParamType);\n  }\n}\n\nexport class Tzip17ContractAbstraction {\n  methods: { [key: string]: (...args: any[]) => ContractMethodTzip17<ContractProvider | Wallet> } = {};\n  constructor(\n    private contractAbstraction: ContractAbstraction<ContractProvider | Wallet>,\n    private context: Context\n  ) {\n    for (let method in this.contractAbstraction.methods) {\n      const methodFx = (...args: any[]) => {\n        return new ContractMethodTzip17<ContractProvider | Wallet>(\n          context,\n          this.contractAbstraction,\n          this.contractAbstraction.methods[method],\n          this.contractAbstraction.entrypoints.entrypoints[method],\n          args\n        )\n      }\n      this.methods[method] = methodFx\n    }\n  }\n}\n"],"names":[],"mappings":"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"}